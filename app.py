import streamlit as st
import pandas as pd
import os
from datetime import datetime, timedelta
import uuid

# 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø©
st.set_page_config(page_title="Ù†Ø¸Ø§Ù… Ø£Ø¨Ùˆ Ø¹Ù…Ø± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ 2026", layout="wide", page_icon="ğŸ")

def format_num(val):
    try:
        if val == int(val): return str(int(val))
        return str(round(val, 2))
    except: return str(val)

def clean_num(text):
    try:
        if text is None or text == "": return 0.0
        return float(str(text).replace(',', '.').replace('ØŒ', '.'))
    except: return 0.0

# 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
FILES = {
    'sales': ('sales_final.csv', ['date', 'item', 'amount', 'profit', 'method', 'customer_name', 'customer_phone', 'bill_id']),
    'expenses': ('expenses_final.csv', ['date', 'reason', 'amount']),
    'waste': ('waste_final.csv', ['date', 'item', 'qty', 'loss_value']),
    'adjust': ('inventory_adjustments.csv', ['date', 'item', 'diff_qty', 'loss_value'])
}

for key, (file, cols) in FILES.items():
    state_key = f"{key}_df"
    if state_key not in st.session_state:
        if os.path.exists(file):
            df = pd.read_csv(file)
            for c in cols: 
                if c not in df.columns: df[c] = 0.0 if 'amount' in c or 'profit' in c or 'loss' in c or 'qty' in c else ""
            st.session_state[state_key] = df
        else:
            st.session_state[state_key] = pd.DataFrame(columns=cols)

if 'inventory' not in st.session_state:
    st.session_state.inventory = pd.read_csv('inventory_final.csv', index_col=0).to_dict('index') if os.path.exists('inventory_final.csv') else {}
if 'categories' not in st.session_state:
    st.session_state.categories = pd.read_csv('categories_final.csv')['name'].tolist() if os.path.exists('categories_final.csv') else ["Ø®Ø¶Ø§Ø± ÙˆÙÙˆØ§ÙƒÙ‡", "Ù…ÙƒØ³Ø±Ø§Øª"]

def auto_save():
    pd.DataFrame(st.session_state.inventory).T.to_csv('inventory_final.csv')
    st.session_state.sales_df.to_csv('sales_final.csv', index=False)
    st.session_state.expenses_df.to_csv('expenses_final.csv', index=False)
    st.session_state.waste_df.to_csv('waste_final.csv', index=False)
    st.session_state.adjust_df.to_csv('inventory_adjustments.csv', index=False)
    pd.DataFrame(st.session_state.categories, columns=['name']).to_csv('categories_final.csv', index=False)

# 3. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
st.markdown("""
    <style>
    [data-testid="stSidebar"] { background-color: #2c3e50 !important; border-left: 1px solid #27ae60; }
    [data-testid="stSidebar"] .stRadio div label p { color: white !important; font-weight: 900; font-size: 20px; padding: 10px; border-radius: 5px; }
    .sidebar-user { color: #27ae60 !important; font-weight: 900; font-size: 26px; text-align: center; margin-bottom: 25px; border-bottom: 3px solid #27ae60; padding-bottom: 15px; }
    .main-title { color: #2c3e50; text-align: center; border-bottom: 5px solid #27ae60; padding-bottom: 10px; font-weight: 900; margin-bottom: 30px; border-radius: 10px; }
    </style>
    """, unsafe_allow_html=True)

# 4. Ø§Ù„Ù†Ø¸Ø§Ù…
if 'logged_in' not in st.session_state:
    st.markdown("<h1 class='main-title'>ğŸ”’ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø£Ø¨Ùˆ Ø¹Ù…Ø±</h1>", unsafe_allow_html=True)
    pwd = st.text_input("ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©", type="password")
    if st.button("Ø¯Ø®ÙˆÙ„"):
        if pwd == "123": st.session_state.logged_in = True; st.rerun()
else:
    st.sidebar.markdown("<div class='sidebar-user'>Ø£Ù‡Ù„Ø§Ù‹ Ø£Ø¨Ùˆ Ø¹Ù…Ø± ğŸ‘‹</div>", unsafe_allow_html=True)
    menu = st.sidebar.radio("Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹", ["ğŸ›’ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹", "ğŸ“¦ Ø§Ù„Ù…Ø®Ø²Ù† ÙˆØ§Ù„Ø¬Ø±Ø¯", "ğŸ’¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª", "ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©", "âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"])

    if menu == "ğŸ›’ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹":
        st.markdown("<h1 class='main-title'>ğŸ›’ Ø´Ø§Ø´Ø© Ø¨ÙŠØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©</h1>")
        # (Ø¨Ù‚ÙŠØ© ÙƒÙˆØ¯ Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø£ØµÙ„ÙŠ ÙƒÙ…Ø§ Ù‡Ùˆ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±)
        # ... [Ù‡Ù†Ø§ ÙŠØªÙ… ÙˆØ¶Ø¹ ÙƒÙˆØ¯ Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø£ØµÙ„ÙŠ] ...

    elif menu == "ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©":
        st.markdown("<h1 class='main-title'>ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„ØªÙØµÙŠÙ„ÙŠØ©</h1>", unsafe_allow_html=True)
        
        # ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
        sales = st.session_state.sales_df.copy(); sales['date_dt'] = pd.to_datetime(sales['date'])
        exps = st.session_state.expenses_df.copy(); exps['date_dt'] = pd.to_datetime(exps['date'])
        wastes = st.session_state.waste_df.copy(); wastes['date_dt'] = pd.to_datetime(wastes['date'])
        adjs = st.session_state.adjust_df.copy(); adjs['date_dt'] = pd.to_datetime(adjs['date'])

        today = datetime.now().date()
        start_week = today - timedelta(days=today.weekday())

        # --- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„: Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ø£Ø³Ø¨ÙˆØ¹ ---
        c1, c2 = st.columns(2)
        day_total = sales[sales['date_dt'].dt.date == today]['amount'].sum()
        week_total = sales[sales['date_dt'].dt.date >= start_week]['amount'].sum()
        c1.metric("ğŸ’° Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…", f"{format_num(day_total)} â‚ª")
        c2.metric("ğŸ“… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹", f"{format_num(week_total)} â‚ª")

        # --- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù†ÙŠ: ØµØ§ÙÙŠ Ø±Ø¨Ø­ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ---
        w_profit = sales[sales['date_dt'].dt.date >= start_week]['profit'].sum()
        w_exp = exps[exps['date_dt'].dt.date >= start_week]['amount'].sum()
        w_waste = wastes[wastes['date_dt'].dt.date >= start_week]['loss_value'].sum()
        w_adj = adjs[adjs['date_dt'].dt.date >= start_week]['loss_value'].sum()
        net_week = w_profit - w_exp - w_waste - w_adj
        st.subheader(f"ğŸ“ˆ ØµØ§ÙÙŠ Ø±Ø¨Ø­ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: {format_num(net_week)} â‚ª")
        
        st.divider()

        # --- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù„Ø«: Ø§Ù„Ø¨Ø­Ø« Ø¨ØªØ§Ø±ÙŠØ® Ù…Ø­Ø¯Ø¯ ---
        st.markdown("### ğŸ” Ø¬Ø±Ø¯ ÙŠÙˆÙ… Ù…Ø­Ø¯Ø¯")
        search_date = st.date_input("Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…:", today)
        day_sales = sales[sales['date_dt'].dt.date == search_date]
        day_p = day_sales['profit'].sum()
        day_a = day_sales['amount'].sum()
        st.write(f"ÙÙŠ ØªØ§Ø±ÙŠØ® {search_date}: Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª **{format_num(day_a)} â‚ª** | Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø®Ø§Ù… **{format_num(day_p)} â‚ª**")
        if not day_sales.empty:
            st.dataframe(day_sales[['item', 'amount', 'profit', 'method']], use_container_width=True)

        st.divider()

        # --- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø¹: ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ù†ÙØµÙ„ ---
        st.markdown("### ğŸ“‹ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ (ÙŠÙˆÙ…ÙŠ)")
        week_report = sales[sales['date_dt'].dt.date >= start_week].copy()
        if not week_report.empty:
            week_report['Ø§Ù„ÙŠÙˆÙ…'] = week_report['date_dt'].dt.date
            daily_summary = week_report.groupby('Ø§Ù„ÙŠÙˆÙ…').agg({'amount': 'sum', 'profit': 'sum'}).reset_index()
            st.table(daily_summary.rename(columns={'amount': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', 'profit': 'Ø§Ù„Ø£Ø±Ø¨Ø§Ø­'}))
        else:
            st.write("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø¨Ø¹Ø¯.")

    # (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: Ø§Ù„Ù…Ø®Ø²Ù†ØŒ Ø§Ù„Ù…ØµØ±ÙˆÙØ§ØªØŒ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ ØªÙ…Ø§Ù…Ø§Ù‹)
